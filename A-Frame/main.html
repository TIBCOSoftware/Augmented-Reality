<!DOCTYPE html>
<html>

<head>
    <title>A-Frame: Quest movement and interaction</title>
    <meta name="description" content="Moving around an A-Frame scene with Quest touch controllers.">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="js/aframe-environment-component.js"></script>
    <script src="js/controller-listener.js"></script>
    <script src="js/player-move.js"></script>
    <script src="js/raycaster-extras.js"></script>
    <script src="js/tibco/credentials.js"></script>
    <script src="js/tibco/tibco-liveapps.js"></script>
    <script src="js/tibco/eftl.js"></script>
    <script src="js/tibco/tibco-eftl.js"></script>
    <script src="js/tibco/tibco-eftl-display.js"></script>
</head>

<body>

<script>

// place object on top of an object
AFRAME.registerComponent('on-top', {
  schema: {
    target: {
      type: 'string'
    }
  },
  init: function() {
    var el = this.el;
    this.baseObject = document.querySelector(this.data.target).object3D;
    this.baseObjectBox = new THREE.Box3().setFromObject(this.baseObject);


    el.addEventListener('model-loaded', function(e) {
      // compute bounding box
      var obj = this.el.getObject3D('mesh');
      // compute bounding box
      try {
        var bbox = new THREE.Box3().setFromObject(obj);
      //console.log(bbox.min, bbox.max);
        this.el.object3D.position.x = this.baseObject.position.x;
        this.el.object3D.position.y = this.baseObjectBox.max.y - bbox.min.y;
        this.el.object3D.position.z = this.baseObject.position.z;
      } catch (e) {
        this.el.object3D.position.x = this.baseObject.position.x;
        this.el.object3D.position.y = this.baseObjectBox.max.y;
        this.el.object3D.position.z = this.baseObject.position.z;
      }

    }.bind(this));
  }
});
// if raycaster is pointing at this object, press trigger to change color
AFRAME.registerComponent("raycaster-color-change", {
    init: function ()
    {
        this.colors = ["red", "orange", "yellow", "green", "blue", "violet"];

        this.controllerData = document.querySelector("#controller-data").components["controller-listener"];
        this.hoverData      = this.el.components["raycaster-target"];
    },

    tick: function()
    {
        if (this.hoverData.hasFocus && this.controllerData.rightTrigger.pressed )
        {
            let index = Math.floor( this.colors.length * Math.random() );
            let color = this.colors[index];
            this.el.setAttribute("color", color);
        }

        if (!this.hoverData.hasFocus || this.controllerData.rightTrigger.released)
        {
            this.el.setAttribute("color", "#CCCCCC");
        }
    }
});

AFRAME.registerComponent("robot-arm", {
    init: function ()
    {
      var base = document.createElement('a-gltf-model');
      base.setAttribute('src', `assets/arm/arm-01.glb`);
      //base.setAttribute('shadow',"cast: true;receive: false");
      base.object3D.position.z = 0.0;
      base.object3D.position.x = 0.0;
      base.object3D.position.y = 0.0;
      var rotating = document.createElement('a-gltf-model');
      rotating.setAttribute('src', `assets/arm/arm-02.glb`);
      //rotating.setAttribute('shadow',"cast: true;receive: false");
      rotating.object3D.position.z = 0.0;
      rotating.object3D.position.x = 0.0;
      rotating.object3D.position.y = 0.35;

      var connecting = document.createElement('a-gltf-model');
      connecting.setAttribute('src', `assets/arm/arm-connecting.gltf`);
      //connecting.setAttribute('shadow',"cast: true;receive: false");

      connecting.object3D.position.x = -0.17;
      connecting.object3D.position.y = 0.25;
      connecting.object3D.position.z = 0.0;

      var forearm = document.createElement('a-gltf-model');
      forearm.setAttribute('src', `assets/arm/arm-04.glb`);
      //forearm.setAttribute('shadow',"cast: true;receive: false");

      forearm.object3D.position.x = 0.0;
      forearm.object3D.position.y = 0.817;
      forearm.object3D.position.z = 0.0;
      //this.el.appendChild(forearm);
      rotating.appendChild(connecting);
      connecting.appendChild(forearm);
      base.appendChild(rotating);
      this.el.appendChild(base);

    }
});


</script>

<a-scene environment="preset: tron;dressing: none" renderer="antialias: true;">


    <a-assets>
        <img id="gradient" src="images/gradient-fade.png" />
    </a-assets>

    <!-- use a simple mesh for raycasting/navigation -->
    <a-plane
        width="100" height="100"
        rotation="-90 0 0"
        position="0 0.01 0"
        visible="false"
        class="groundPlane"
        raycaster-target>
    </a-plane>

    <a-entity
        id="player"
        position="0 0 0"
        player-move="controllerListenerId: #controller-data;
                     navigationMeshClass: groundPlane;">

        <a-camera></a-camera>

        <a-entity
            id="controller-data"
            controller-listener="leftControllerId:  #left-controller;
                                 rightControllerId: #right-controller;">
        </a-entity>

        <a-entity
            id="left-controller"
            oculus-touch-controls="hand: left">
        </a-entity>

        <!-- experiment with raycasting interval; slight performance improvement but jittery appearance in world -->
        <a-entity
            id="right-controller"
            oculus-touch-controls="hand: right"
            raycaster="objects: .raycaster-target; interval: 0;"
            raycaster-extras="controllerListenerId: #controller-data;
                              beamImageSrc: #gradient; beamLength: 0.5;">
        </a-entity>

    </a-entity>

    <a-entity  id="liveapps" tibco-liveapps="applicationName:Info Card; search:Industrial"></a-entity>
    <a-entity  tibco-liveapps-display="liveappsLoaderId:#liveapps;attr:Name;equals:Power Box" position = "-1 0.5 -3"></a-entity>

    <a-entity id="eftl" tibco-eftl="URL:EFTL_URL;key:EFTL_KEY"></a-entity>

    <a-entity position = "1 5 0"  light="type: directional; color: #BBB; target:#table; castShadow:true "></a-entity>


   <!--a-box id="table" shadow="receive: true" depth="1" height="1" width="1" position="0 0.5 -2" color="#284a9e"></a-box-->
   <a-cylinder id="table1" shadow="receive: true" color="#284a9e" height="1" radius="0.5" position="0 0.5 -2"></a-cylinder>
   <a-gltf-model on-top="target:#table1"  src="assets/power_box/power_box_01_1k.gltf" shadow="cast: true;receive: false">
  </a-gltf-model>
   <a-cylinder id="table2" shadow="receive: true" color="#284a9e" height="1" radius="0.5" position="2 0.5 -2"></a-cylinder>
   <a-gltf-model on-top="target:#table2"  src="assets/arm/arm-connecting.gltf" shadow="cast: true;receive: false"></a-gltf-model>
   <a-cylinder id="table3" shadow="receive: true" color="#284a9e" height="1" radius="0.5" position="-2 0.5 -2"></a-cylinder>
   <a-entity robot-arm on-top="target:#table3" shadow="cast: true;receive: false"></a-entity>
   <!--a-gltf-model on-top="target:#table"  src="assets/extinguisher/extinguisher.gltf" shadow="cast: true;receive: false"></a-gltf-model-->
   <a-entity position="-1.5 1 -1.5" tibco-eftl-display="eftlListenerId:#eftl"/>

    <!--a-sphere
        radius = "1.25"
        position = "0 1.25 -5"
        color = "#DDBB00"
        raycaster-target>
    </a-sphere-->



</a-scene>

</body>
</html>
